<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <script src="https://kit.fontawesome.com/c5e0b36bfd.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="../css/main.css" />
        <title>main</title>
    </head>
    <body>
        <header>
            <div class="header_logo">
                <img src="../img/header_logo.png" alt="Header Logo Image" />
            </div>
            <div class="header_search">
                <input type="text" placeholder="검색어를 입력해주세요" />
            </div>
            <div class="header_logbtn">
                <a href="../static/login.html">
                    <button type="button">로그인/회원가입</button>
                </a>
            </div>
        </header>
        <main>
            <div class="main_top_wrap">
                <div class="main_top_tap_wrap">
                    <div class="main_top_tap on">주가지수</div>
                    <div class="main_top_tap">채권</div>
                    <div class="main_top_tap">원자재</div>
                </div>
                <div class="main_top_block_wrap">
                    <div class="main_top_block">
                        <div class="main_top_block_market">
                            <div class="main_top_block_market_name">나스닥</div>
                            <div class="main_top_block_market_img">
                                <img src="../img/flag_us.png" alt="미국 국기" />
                            </div>
                        </div>
                        <div class="main_top_block_cost">17,928.92</div>
                        <div class="main_top_block_fluc up">
                            <div class="main_top_block_fluc_cost">+0.78</div>
                            <div class="main_top_block_fluc_rate">(0.0043%)</div>
                        </div>
                    </div>
                    <div class="main_top_block">
                        <div class="main_top_block_market">
                            <div class="main_top_block_market_name">나스닥</div>
                            <div class="main_top_block_market_img">
                                <img src="../img/flag_us.png" alt="미국 국기" />
                            </div>
                        </div>
                        <div class="main_top_block_cost">17,928.92</div>
                        <div class="main_top_block_fluc up">
                            <div class="main_top_block_fluc_cost">+0.78</div>
                            <div class="main_top_block_fluc_rate">(0.0043%)</div>
                        </div>
                    </div>
                    <div class="main_top_block">
                        <div class="main_top_block_market">
                            <div class="main_top_block_market_name">나스닥</div>
                            <div class="main_top_block_market_img">
                                <img src="../img/flag_us.png" alt="미국 국기" />
                            </div>
                        </div>
                        <div class="main_top_block_cost">17,928.92</div>
                        <div class="main_top_block_fluc up">
                            <div class="main_top_block_fluc_cost">+0.78</div>
                            <div class="main_top_block_fluc_rate">(0.0043%)</div>
                        </div>
                    </div>
                    <div class="main_top_block">
                        <div class="main_top_block_market">
                            <div class="main_top_block_market_name">나스닥</div>
                            <div class="main_top_block_market_img">
                                <img src="../img/flag_us.png" alt="미국 국기" />
                            </div>
                        </div>
                        <div class="main_top_block_cost">17,928.92</div>
                        <div class="main_top_block_fluc up">
                            <div class="main_top_block_fluc_cost">+0.78</div>
                            <div class="main_top_block_fluc_rate">(0.0043%)</div>
                        </div>
                    </div>
                    <div class="main_top_block">
                        <div class="main_top_block_market">
                            <div class="main_top_block_market_name">나스닥</div>
                            <div class="main_top_block_market_img">
                                <img src="../img/flag_us.png" alt="미국 국기" />
                            </div>
                        </div>
                        <div class="main_top_block_cost">17,928.92</div>
                        <div class="main_top_block_fluc up">
                            <div class="main_top_block_fluc_cost">+0.78</div>
                            <div class="main_top_block_fluc_rate">(0.0043%)</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="main_list_wrap">
                <div class="main_list_menu">
                    <div class="main_list_filter">
                        <div class="main_list_filter_block on">전체</div>
                        <div class="main_list_filter_block">국내</div>
                        <div class="main_list_filter_block">해외</div>
                    </div>
                    <div class="main_list_sort_wrap">
                        <div class="main_list_sort_rate">
                            <div class="main_list_sort_rate_block on">거래대금</div>
                            <div class="main_list_sort_rate_block">거래량</div>
                            <div class="main_list_sort_rate_block">급상승</div>
                            <div class="main_list_sort_rate_block">급하락</div>
                            <div class="main_list_sort_rate_block">인기</div>
                        </div>
                        <div class="main_list_sort_date">
                            <div class="main_list_sort_date_block on">실시간</div>
                            <div class="main_list_sort_date_block">1일</div>
                            <div class="main_list_sort_date_block">1주</div>
                            <div class="main_list_sort_date_block">1개월</div>
                            <div class="main_list_sort_date_block">1년</div>
                        </div>
                    </div>
                </div>
                <div class="main_list">
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>종목</th>
                                <th>현재가</th>
                                <th>등락률</th>
                                <th>거래대금</th>
                                <th>거래량</th>
                            </tr>
                        </thead>
                        <tbody id="stock_tableBody"></tbody>
                    </table>
                </div>
                <div class="main_list_pagenation">
                    <div class="page_prev"><i class="fa-solid fa-chevron-left"></i></div>
                    <div class="page_next">
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>
                </div>
            </div>
            <div class="main_chat"></div>
        </main>
        <footer>
            <div class="footer_logo">
                <img src="../img/header_logo.png" alt="Footer Logo Image" />
            </div>
            <div class="footer_pj">
                <div class="footer_pj_name">오올</div>
                <div class="footer_pj_people">김용주, 김태은, 안지영, 장유석, 김예리</div>
            </div>
            <div class="footer_pj_link">
                <a href="https://github.com/OOL-Project-2025/OOL_Project" target="_blank"><img src="../img/footer_github.png" alt="github logo" class="footer_pjimg" /></a>
                <a href="http://"><img src="../img/footer_notion.png" alt="notion logo" class="footer_pjimg" /></a>
                <a href="https://www.figma.com/design/qZRKhlqrbYXMHYN8e7us0p/%EC%A6%9D%EA%B6%8C-%EC%9B%B9?node-id=120-15448&t=olCoN2OVm52y5p2D-0" target="_blank">
                    <img src="../img/footer_figma.png" alt="figma logo" class="footer_pjimg"
                /></a>
            </div>
        </footer>
        <div class="chat_wrap">
            <div class="chat_btn">
                <img src="../img/chat_icon.png" alt="채팅창 아이콘" />
            </div>
            <div class="chat_popup">
                <div class="chat_popup_top">
                    <div class="chat_popup_title">
                        <div class="chat_popup_title_txt">채팅</div>
                        <div class="chat_popup_closebtn"><img src="../img/close_icon.png" alt="닫기 버튼" /></div>
                    </div>
                    <div class="chat_popup_content">
                        <div class="chat_talk_block">
                            <div class="chat_talk_profile">
                                <div class="chat_talk_profile_img"><img src="../img/profile_default.png" alt="기본 프로필 이미지" /></div>
                            </div>
                            <div class="chat_talk">
                                <div class="chat_talk_profile_name">예렌버핏</div>
                                <div class="chat_talk_bubble_wrap">
                                    <div class="chat_talk_bubble">오 님들 오늘 코스피 좋은데요</div>
                                    <div class="chat_talk_bubble">나스닥은 에바던데</div>
                                    <div class="chat_talk_bubble">
                                        내 엔비디아 ㅜ
                                        <div class="chat_talk_time">14:32</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chat_talk_block mychat">
                            <div class="chat_talk_bubble_wrap">
                                <div class="chat_talk_bubble">ㄱㅊ 엔비디아는 언젠간 오름</div>
                                <div class="chat_talk_bubble">
                                    전원주 투자법 가즈아
                                    <div class="chat_talk_time">14:33</div>
                                </div>
                            </div>
                        </div>
                        <div class="chat_talk_block">
                            <div class="chat_talk_profile">
                                <div class="chat_talk_profile_img"><img src="../img/profile_default.png" alt="기본 프로필 이미지" /></div>
                            </div>
                            <div class="chat_talk">
                                <div class="chat_talk_profile_name">예렌버핏</div>
                                <div class="chat_talk_bubble_wrap">
                                    <div class="chat_talk_bubble">오 님들 오늘 코스피 좋은데요</div>
                                    <div class="chat_talk_bubble">나스닥은 에바던데</div>
                                    <div class="chat_talk_bubble">
                                        내 엔비디아 ㅜ
                                        <div class="chat_talk_time">14:32</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chat_talk_block mychat">
                            <div class="chat_talk_bubble_wrap">
                                <div class="chat_talk_bubble">ㄱㅊ 엔비디아는 언젠간 오름</div>
                                <div class="chat_talk_bubble">전원주 투자법 가즈아</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chat_popup_input_wrap">
                    <div class="chat_popup_input">
                        <input type="text" placeholder="검색어를 입력해주세요" />
                    </div>
                    <button class="chat_popup_input_btn"><img src="../img/chatInput_icon.png" alt="채팅 보내기 버튼" /></button>
                </div>
            </div>
        </div>

        <script>
            // 주식 데이터불러오기
            const API_BASE = "http://oolfinance.kro.kr";
            let globalDataList = [];
            let currentPage = 1;
            const pageSize = 10;

            async function fetchIndices() {
                try {
                    const res = await fetch(`${API_BASE}/api/stocks`);
                    const data = await res.json();
                    const dataList = data.data;
                    const usedata = [];
                    dataList.forEach((element) => {
                        if (["005490", "005930", "259960"].includes(element.stockCode)) {
                            usedata.push(element);
                        }
                    });
                    return usedata;
                } catch (err) {
                    console.error("Error fetching indices:", err);
                    return [];
                }
            }

            fetchIndices().then((dataList) => {
                console.log(dataList);
                globalDataList = dataList;
                currentPage = 1;
                renderTable();
                renderPagination();
            });

            function renderTable() {
                const tbody = document.getElementById("stock_tableBody");
                tbody.innerHTML = "";

                // 현재 페이지 범위 계산
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                const pageItems = globalDataList.slice(start, end);

                pageItems.forEach((item, index) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${start + index + 1}</td>
                        <td>
                            <div class="stock_img us">
                            <img src="../img/stock_tesla.png" alt="${item.stockName} 로고 이미지" />
                            </div>
                            <div class="stock_name">${item.stockName}</div>
                        </td>
                        <td>$${item.currentClose ?? "-"}</td>
                        <td>${item.previousClose ?? "-"}</td>
                        <td>${item.tradingValue ?? "-"} 억원</td>
                        <td>${item.tradingVolume ?? "-"} 주</td>
                        `;

                    tr.addEventListener("click", () => {
                        window.location.href = `http://127.0.0.1:5500/src/main/resources/static/stock_detail.html?code=${item.stockCode}`;
                    });
                    tbody.appendChild(tr);
                });
            }
            function renderPagination() {
                const pagination = document.querySelector(".main_list_pagenation");
                pagination.innerHTML = `
                <div class="page_prev"><i class="fa-solid fa-chevron-left"></i></div>
                <div class="page_next"><i class="fa-solid fa-chevron-right"></i></div>
                `;

                const totalPages = Math.ceil(globalDataList.length / pageSize);
                const prevBtn = pagination.querySelector(".page_prev");
                const nextBtn = pagination.querySelector(".page_next");

                // 페이지 번호 동적으로 생성
                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement("div");
                    btn.className = "page_number" + (i === currentPage ? " on" : "");
                    btn.textContent = i;

                    btn.addEventListener("click", () => {
                        currentPage = i;
                        renderTable();
                        renderPagination(); // 버튼 다시 그리기
                    });

                    pagination.insertBefore(btn, nextBtn); // next 버튼 앞에 삽입
                }

                // 이전 버튼
                prevBtn.addEventListener("click", () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderTable();
                        renderPagination();
                    }
                });

                // 다음 버튼
                nextBtn.addEventListener("click", () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderTable();
                        renderPagination();
                    }
                });
            }

            // 실행
            fetchIndices();

            // *** 필터/솔트 기능
            const top_block = document.querySelectorAll(".main_top_tap");
            const filter_block = document.querySelectorAll(".main_list_filter_block");
            const rate_block = document.querySelectorAll(".main_list_sort_rate_block");
            const date_block = document.querySelectorAll(".main_list_sort_date_block");
            const page_number = document.querySelectorAll(".page_number");

            // 주가지수, 채권, 원자재 탭
            top_block.forEach(function (block) {
                block.addEventListener("click", function () {
                    top_block.forEach((el) => el.classList.remove("on"));
                    this.classList.add("on");
                });
            });

            // 전체, 국내, 해외 탭
            filter_block.forEach(function (block) {
                block.addEventListener("click", function () {
                    filter_block.forEach((el) => el.classList.remove("on"));
                    this.classList.add("on");
                });
            });

            // 거래대금, 거래량, 급상승, 급하락, 인기 탭
            rate_block.forEach(function (block) {
                block.addEventListener("click", function () {
                    rate_block.forEach((el) => el.classList.remove("on"));
                    this.classList.add("on");
                });
            });

            // 실시간, 1일, 1주, 1개월, 1년 탭
            date_block.forEach(function (block) {
                block.addEventListener("click", function () {
                    date_block.forEach((el) => el.classList.remove("on"));
                    this.classList.add("on");
                });
            });

            // 페이지네이션
            page_number.forEach(function (block) {
                block.addEventListener("click", function () {
                    page_number.forEach((el) => el.classList.remove("on"));
                    this.classList.add("on");
                });
            });
            // 채팅창
            const chatPopup = document.querySelector(".chat_popup");
            const chatContent = document.querySelector(".chat_popup_content");
            const chatInput = document.querySelector(".chat_popup_input input");
            const sendBtn = document.querySelector(".chat_popup_input_btn");
            const chatBtn = document.querySelector(".chat_btn");
            const chatPopupClosebtn = document.querySelector(".chat_popup_closebtn");

            chatBtn.addEventListener("click", function () {
                const isOpen = chatPopup.style.display === "block";
                chatPopup.style.display = isOpen ? "none" : "block";
                // 채팅창 최하단 비추기
                chatContent.scrollTop = chatContent.scrollHeight;
            });
            chatPopupClosebtn.addEventListener("click", function () {
                chatPopup.style.display = "none";
            });
            // 채팅창 입력창에 텍스트가 있을떄
            chatInput.addEventListener("input", () => {
                if (chatInput.value.trim() !== "") {
                    sendBtn.classList.add("on");
                } else {
                    sendBtn.classList.remove("on");
                }
            });

            // 메시지 전송
            chatInput.addEventListener("input", () => {
                sendBtn.classList.toggle("on", chatInput.value.trim() !== "");
            });

            window.addEventListener("load", () => {
                chatContent.scrollTop = chatContent.scrollHeight;
            });

            function sendMessage() {
                const text = chatInput.value.trim();
                if (text === "") return;

                let lastBlock = [...chatContent.querySelectorAll(".chat_talk_block.mychat")].pop();
                let bubbleWrap;

                // 조건: 마지막 블록이 없거나 4개 이상이면 새로 생성
                if (!lastBlock || lastBlock.querySelectorAll(".chat_talk_bubble").length >= 4) {
                    lastBlock = document.createElement("div");
                    lastBlock.className = "chat_talk_block mychat";

                    bubbleWrap = document.createElement("div");
                    bubbleWrap.className = "chat_talk_bubble_wrap";

                    lastBlock.appendChild(bubbleWrap);
                    chatContent.appendChild(lastBlock);
                } else {
                    bubbleWrap = lastBlock.querySelector(".chat_talk_bubble_wrap");
                }

                // 버블 생성
                const bubble = document.createElement("div");
                bubble.className = "chat_talk_bubble";
                bubble.textContent = text;

                // 추가
                bubbleWrap.appendChild(bubble);

                // 초기화
                chatInput.value = "";
                sendBtn.classList.remove("on");

                // 스크롤
                chatContent.scrollTop = chatContent.scrollHeight;
            }

            // 버튼 클릭
            sendBtn.addEventListener("click", sendMessage);

            let isComposing = false;

            chatInput.addEventListener("compositionstart", () => {
                isComposing = true;
            });

            chatInput.addEventListener("compositionend", () => {
                isComposing = false;
            });
            // 엔터키
            chatInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter" && !isComposing) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        </script>
        <!-- <h2>로그인한 아이디 확인:</h2>
        <p id="loginId">세션 확인 중...</p>
        <a href="/wishlistCategory.html">카테고리 관리</a>
        <a href="/memberUpdate.html">내 정보 수정하기</a>
        <button onclick="logout()">로그아웃</button>
        <button id="deleteMemberBtn">회원 탈퇴</button> -->
        <!-- 
        <script>
            fetch("/api/session/login-id")
                .then((response) => response.text())
                .then((data) => {
                    const loginIdElement = document.getElementById("loginId");
                    if (data === "NO_SESSION") {
                        loginIdElement.innerText = "로그인되지 않았습니다.";
                    } else {
                        loginId = data;
                        loginIdElement.innerText = `로그인 아이디: ${data}`;
                    }
                })
                .catch((error) => {
                    console.error("세션 조회 실패:", error);
                    document.getElementById("loginId").innerText = "오류 발생";
                });

            function logout() {
                fetch("/api/logout", { method: "POST" })
                    .then(() => {
                        alert("로그아웃 되었습니다.");
                        window.location.href = "/login.html"; // 로그인 페이지로 이동
                    })
                    .catch((err) => {
                        console.error("로그아웃 오류", err);
                    });
            }

            // 회원 탈퇴 버튼 클릭 시
            document.getElementById("deleteMemberBtn").addEventListener("click", () => {
                if (!loginId) {
                    alert("로그인 정보가 없습니다.");
                    return;
                }

                const confirmed = confirm("정말로 회원 탈퇴하시겠습니까? 이 작업은 되돌릴 수 없습니다.");

                if (confirmed) {
                    fetch(`/member/delete/${loginId}`, {
                        method: "DELETE",
                    })
                        .then((response) => {
                            if (response.ok) {
                                alert("회원 탈퇴가 완료되었습니다.");
                                window.location.href = "/login.html"; // 로그인 페이지로 이동
                            } else {
                                alert("회원 탈퇴에 실패했습니다.");
                            }
                        })
                        .catch((error) => {
                            console.error("삭제 요청 중 오류 발생:", error);
                            alert("오류가 발생했습니다.");
                        });
                }
            });
        </script> -->
    </body>
</html>
